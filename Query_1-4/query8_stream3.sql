select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '73723','83781','98233','76514','73008','25945',
                          '94369','88327','56294','70090','68315',
                          '35662','79650','32613','79009','59079',
                          '57906','45099','16526','13061','16369',
                          '27520','49210','73482','17474','32723',
                          '65332','58797','21932','84150','66178',
                          '37872','78064','82674','34756','77961',
                          '74321','35228','66724','66147','25472',
                          '82880','82475','73976','14130','36796',
                          '58286','68270','50958','86910','92503',
                          '74927','29093','99047','74986','78061',
                          '78813','91684','78102','65803','44083',
                          '90118','14504','40916','31228','77798',
                          '58438','28118','17951','64421','64966',
                          '54764','18164','25577','20659','98580',
                          '81787','80529','23381','76669','47972',
                          '75695','76809','53359','91703','30543',
                          '67110','44370','25297','54097','23899',
                          '39445','41812','29157','39601','75955',
                          '47043','91852','68109','34783','98711',
                          '67134','94104','77279','90811','17088',
                          '70109','43653','51339','58957','77199',
                          '90197','76480','54922','84814','72714',
                          '96530','27284','52501','95768','91551',
                          '14398','70820','98563','83951','16086',
                          '48046','26022','18205','19384','24412',
                          '55058','55379','34211','80499','17182',
                          '31819','48415','33476','62331','99922',
                          '78272','23228','53801','14545','36804',
                          '60918','54287','77566','56675','62509',
                          '79923','58359','11629','14240','42505',
                          '34524','27183','42035','41523','95327',
                          '47249','83808','13235','47714','86887',
                          '26863','55867','61368','17040','82367',
                          '10358','11403','39060','95692','13936',
                          '95872','25494','37064','97166','88504',
                          '54630','29844','78613','62278','54800',
                          '65430','19129','11863','54955','90665',
                          '52518','35566','82971','89587','47633',
                          '88970','35600','24069','70720','54322',
                          '47139','62693','12832','88765','54907',
                          '52611','59732','59975','82520','33438',
                          '42625','89799','16366','11405','89221',
                          '71097','29049','71928','57435','99999',
                          '48062','49566','87200','22731','61594',
                          '96035','52138','51126','38828','36395',
                          '47783','26139','15411','40655','11003',
                          '95395','78179','25650','68213','84235',
                          '45346','84143','18227','58810','45902',
                          '82766','73628','92400','46767','30004',
                          '61077','70727','36577','12344','69369',
                          '22120','68324','24111','42814','13276',
                          '22562','30749','38867','71038','14331',
                          '98921','20726','97335','59159','40801',
                          '86567','71876','45382','88397','58997',
                          '21078','81632','98624','28457','46365',
                          '22690','65240','12783','76409','31843',
                          '22962','57081','50262','81994','92190',
                          '50127','34109','25680','90029','92361',
                          '62688','76068','60768','83299','22035',
                          '81461','75488','83620','96155','91415',
                          '42255','97224','34877','38747','87842',
                          '24945','15540','69653','47664','50515',
                          '49396','97031','37712','25904','96501',
                          '13263','86165','43202','67996','38386',
                          '85753','86458','85571','26999','48801',
                          '93218','57290','18709','28738','64043',
                          '79321','10501','30685','69600','33180',
                          '44041','85599','68174','54427','73154',
                          '94425','84587','46260','69512','45565',
                          '33883','43915','98662','93935','82523',
                          '35297','47991','80526','14228','41896',
                          '98636','32654','29061','93630','98312',
                          '21240','53923','10053','67368','38334',
                          '49132','16046','60022','84517','13935',
                          '29147','56816','73658','92983','97145',
                          '57217','54391','95903','44809','14380',
                          '50344','57360','11129','20825','70508',
                          '95649','64842','21879','21082','64961',
                          '81058','75418','19224','44542')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;
