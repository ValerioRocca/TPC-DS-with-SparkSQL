select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '79132','20019','58664','17726','91113','14383',
                          '42909','47893','35879','17653','65489',
                          '70629','59021','54839','55442','41011',
                          '43056','87682','75645','46604','20483',
                          '30808','91289','37552','63407','42891',
                          '44545','37449','85845','78505','55124',
                          '97602','16645','92490','21082','75876',
                          '93112','67760','24896','34173','53199',
                          '53097','96471','31900','64205','20977',
                          '37886','89608','86850','43581','80910',
                          '31551','90364','19514','85911','23592',
                          '53588','57921','99722','96136','85224',
                          '32292','19865','99630','35011','38736',
                          '99985','98339','49365','81953','74084',
                          '48248','98410','41051','24726','40693',
                          '51341','30473','72632','11469','24789',
                          '41779','35537','94118','41937','85165',
                          '85916','74056','74769','35539','12316',
                          '43432','79027','31518','50042','71670',
                          '24786','18185','73190','89692','69495',
                          '62217','49555','86563','58147','72763',
                          '89245','74877','84916','94240','60444',
                          '67335','95155','29090','33514','96112',
                          '96200','19795','95193','87314','15010',
                          '52849','62612','90384','28849','59529',
                          '93373','13470','30533','44953','51773',
                          '29888','44314','32732','31597','65376',
                          '89243','52532','54148','46954','15100',
                          '63815','16180','60547','64808','42328',
                          '25562','32467','53741','69713','23046',
                          '20420','95007','27807','82224','41325',
                          '57887','60849','25399','69017','27393',
                          '22693','74180','57471','48425','52856',
                          '54126','56003','66217','72769','36238',
                          '19536','96742','11428','69924','87986',
                          '52084','36891','28296','48595','85876',
                          '17926','87717','71896','82800','30943',
                          '63475','38633','47973','18278','21646',
                          '43289','82342','55080','56530','90521',
                          '13598','32275','95606','65782','73487',
                          '41597','37467','98122','77780','21694',
                          '67735','39438','46770','81985','86801',
                          '11602','57531','72920','45383','41490',
                          '41771','47333','92242','66420','74396',
                          '36488','72868','29913','13408','97184',
                          '57343','39736','80162','10049','95767',
                          '79416','18857','72136','96789','61030',
                          '94199','70835','53576','19127','16122',
                          '16291','54703','28843','23695','18189',
                          '19913','95348','91116','19374','84129',
                          '74029','94243','86849','97354','55912',
                          '36251','36878','71090','48455','82247',
                          '72226','86683','26026','67273','74442',
                          '54615','14399','98251','65971','86431',
                          '67383','92009','18816','59948','61353',
                          '35336','46053','73699','84532','17586',
                          '17092','88782','50609','21660','38839',
                          '10754','45883','49173','74607','17752',
                          '71789','70290','50220','65706','41802',
                          '94678','72193','64419','67360','42292',
                          '36545','12383','86686','65214','32193',
                          '23191','25545','69463','41932','53301',
                          '16297','61783','42424','79820','73178',
                          '15879','42394','87782','75477','73685',
                          '78631','90422','38282','61326','87431',
                          '64555','25576','98797','45662','26948',
                          '67859','13691','12031','87582','77377',
                          '15544','56880','41910','25938','34492',
                          '81028','85126','49678','34324','98719',
                          '41267','50742','51183','35714','68070',
                          '53248','64756','21723','67606','87920',
                          '46593','25639','11154','54957','50969',
                          '75863','30371','99240','99259','73139',
                          '14986','98687','29746','76574','67519',
                          '30215','25959','68871','73645','13155',
                          '41284','61113','33198','79634','90337',
                          '47805','94238','15140','21757','92007',
                          '70695','99037','16960','44302','38432',
                          '94775','76844','64203','46019','72088',
                          '44417','16557','98131','19274')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;
