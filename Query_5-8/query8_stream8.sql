select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '56866','22271','88291','70371','41077','67177',
                          '78291','32337','20805','49965','58080',
                          '51979','23094','67165','65376','29447',
                          '75249','62663','35212','15301','73935',
                          '98473','25249','11506','67322','28398',
                          '71283','44585','25526','30002','32020',
                          '25816','43073','42208','15559','26654',
                          '37068','75901','18035','66115','27669',
                          '49408','50409','64089','78525','16288',
                          '30906','70135','61196','98891','85046',
                          '25482','91044','78031','19241','48539',
                          '67040','90687','80256','13488','69136',
                          '37882','60870','79797','78911','49575',
                          '22032','59712','30274','23439','95498',
                          '19406','88861','81145','29971','36898',
                          '44198','78729','75765','48189','21763',
                          '67943','26706','41623','41763','81282',
                          '78860','32707','66139','66563','92696',
                          '49556','71687','53091','26694','33233',
                          '71871','91835','55436','99588','53687',
                          '88673','13194','62856','85372','94082',
                          '87815','88292','18448','57418','48351',
                          '47267','27469','11523','84236','78167',
                          '63226','37016','52943','85038','37927',
                          '39386','40638','91245','61412','17637',
                          '97174','52437','78263','83714','20133',
                          '12934','50641','94999','38445','39755',
                          '75882','68907','32400','14905','22853',
                          '53371','48432','53351','20717','31619',
                          '97579','41258','90336','99005','93920',
                          '23825','51656','81820','70349','95926',
                          '34329','34949','48827','77689','21824',
                          '40695','52910','94494','73446','54529',
                          '69884','43064','15603','26647','82051',
                          '25089','40601','91272','24663','46623',
                          '40498','86904','49099','90140','43867',
                          '57616','92461','12190','99201','80070',
                          '52908','15623','36759','23766','99211',
                          '77058','32596','77575','98910','99133',
                          '70426','94184','57845','43382','87742',
                          '10528','80059','97278','52115','66414',
                          '29042','22660','75998','42087','60350',
                          '95383','58893','17897','12147','84054',
                          '40022','45142','89501','86985','64294',
                          '30785','68388','33235','27860','13360',
                          '49792','82284','57381','38213','33849',
                          '24672','40075','52713','28297','62649',
                          '39941','93825','31759','29258','77815',
                          '81041','20047','50454','52669','91000',
                          '69996','16637','61326','40148','87200',
                          '39829','14056','51048','33105','86245',
                          '50996','22452','91140','57456','70610',
                          '53597','16943','14665','52677','31974',
                          '22638','18279','44575','66328','48955',
                          '18564','37354','85538','91116','87612',
                          '84391','51750','66202','56803','61288',
                          '47556','39534','95874','75005','64103',
                          '24623','52957','15131','97840','32616',
                          '72996','86402','44421','69994','86793',
                          '23847','81947','97707','50575','68105',
                          '62098','92754','64046','49283','17309',
                          '91730','69356','50392','18159','68007',
                          '56489','91375','53444','79056','31040',
                          '56450','37731','55070','59715','68879',
                          '13710','32620','97052','96454','20141',
                          '83600','89029','65135','19882','91248',
                          '78228','67050','78500','29070','37226',
                          '95181','43028','45089','24937','74018',
                          '75215','16359','44832','49844','62540',
                          '48878','42471','57172','24782','41056',
                          '76386','31884','90740','81557','82985',
                          '16861','38626','19550','63817','42748',
                          '22637','54107','24616','94466','78678',
                          '30498','76802','96492','47060','70646',
                          '19591','35609','73176','84433','68045',
                          '30013','90363','77056','30359','44776',
                          '50224','42590','83238','46072','76871',
                          '16177','54977','92437','43917','98134',
                          '17956','52632','61296','60877','96902',
                          '90399','50650','37803','97455')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;
