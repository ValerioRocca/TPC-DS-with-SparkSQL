select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '59912','95626','28676','29913','20670','85402',
                          '83060','17623','12901','51193','15196',
                          '29164','53239','79216','87358','16471',
                          '66829','74928','39126','75200','53090',
                          '54354','51164','27804','13813','74360',
                          '22196','73784','12265','38233','64768',
                          '58885','68824','83785','65386','28356',
                          '24607','64504','18164','20454','71382',
                          '41716','71036','39765','24099','15430',
                          '97917','86698','57052','98978','52774',
                          '74109','66842','48291','39349','15267',
                          '24636','91046','25425','40165','35342',
                          '82615','15383','11453','57290','62081',
                          '30076','37581','38007','22950','44806',
                          '23038','66077','88165','24985','59644',
                          '85743','83030','32466','39626','61596',
                          '78886','56278','82496','33992','10793',
                          '84031','41731','72952','55031','73228',
                          '69949','52678','38113','78882','70049',
                          '95333','83145','30222','77022','11026',
                          '12641','63562','45417','97242','74425',
                          '83772','87192','34465','44993','86873',
                          '22986','67019','31062','18334','53618',
                          '12318','48961','79880','21128','28439',
                          '54026','56749','84432','53502','51662',
                          '56542','58865','30277','28930','88791',
                          '78895','82733','47657','73226','92056',
                          '30793','69795','62999','87362','36315',
                          '28452','40669','22221','14083','43151',
                          '98007','28462','23617','63157','90258',
                          '18424','24986','67519','21019','88645',
                          '47274','56089','80035','92840','90237',
                          '12955','34070','84460','99606','84931',
                          '17867','98938','22582','82301','69209',
                          '31030','74521','27441','18634','24840',
                          '67296','32002','38254','81217','92466',
                          '63475','17394','98674','85729','56220',
                          '60753','77965','35200','64897','34610',
                          '14765','10053','76622','34270','49415',
                          '11508','83093','45824','82521','65189',
                          '63401','35927','26088','15720','39676',
                          '88974','28192','82777','53950','54539',
                          '30935','26508','12866','70015','71705',
                          '10033','85034','70782','68368','94804',
                          '16427','27018','56464','55743','99709',
                          '85714','28847','62328','73974','74367',
                          '25341','81924','15824','82263','92347',
                          '91229','65031','25976','15418','28808',
                          '11957','59378','61292','10801','98776',
                          '25128','50548','50655','15927','34290',
                          '45447','58572','13068','93548','39373',
                          '25384','24957','98503','69880','14949',
                          '52913','54544','37534','99292','79858',
                          '26932','91689','13510','87547','29737',
                          '80270','44167','26011','37328','70837',
                          '56314','94565','28363','72269','59064',
                          '50304','12650','68806','53748','46108',
                          '59281','32097','58650','17120','66530',
                          '24465','80455','52317','75129','33536',
                          '21842','54659','19426','39161','82187',
                          '44160','35155','11662','47475','36730',
                          '15033','88576','37240','89785','45582',
                          '58849','56498','80384','93151','80923',
                          '39267','75052','11373','75463','85980',
                          '99341','84985','79342','74258','59469',
                          '61520','67338','22679','98611','70286',
                          '36210','31213','33046','41483','95214',
                          '36942','59751','31754','14864','78024',
                          '46027','88944','24575','25536','69191',
                          '91493','40976','71643','59263','26468',
                          '42557','58998','38197','25661','82529',
                          '82370','40332','41339','70895','59978',
                          '14389','54298','41092','24958','64069',
                          '15759','52708','18677','79374','74606',
                          '43224','52511','50029','47229','32503',
                          '71547','58976','13518','68561','28540',
                          '44646','85810','27551','45038','82769',
                          '68705','51586','45273','62044','70622',
                          '77461','15323','57552','16269','36526',
                          '15898','80057','60462','38260')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;
