select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '63861','35607','93555','72797','86066','12304',
                          '87830','27107','23617','25239','64089',
                          '63098','79389','41431','98511','91485',
                          '57986','60828','92732','48333','43775',
                          '20089','49169','77728','24968','78948',
                          '35395','60657','56598','44407','66451',
                          '83560','13642','91330','69108','39595',
                          '88768','59172','85745','49769','54751',
                          '68816','25362','75735','51482','24784',
                          '57134','12095','25054','50513','48602',
                          '62789','49152','89180','50312','71476',
                          '50940','86070','65516','85980','42799',
                          '56810','69841','39569','40717','12758',
                          '49437','82071','78542','37787','42769',
                          '65134','35826','34491','95954','36051',
                          '33870','64262','73425','19162','67301',
                          '48321','37928','97566','62934','16970',
                          '59274','89492','67729','92949','58200',
                          '85485','24454','81703','62584','52593',
                          '35661','23060','72701','32818','29336',
                          '16405','28272','93040','15186','16854',
                          '28260','93330','78436','33053','65886',
                          '20682','55162','40900','59729','36433',
                          '71317','47579','20974','70706','79545',
                          '31424','30246','21615','83921','52377',
                          '16640','64638','61160','38232','15756',
                          '57895','23824','11503','20435','56025',
                          '95490','39614','85897','62979','23578',
                          '24556','72179','93633','42223','76265',
                          '22912','44146','32144','28911','42847',
                          '76192','10375','89800','40104','84590',
                          '91753','58474','76154','63335','58308',
                          '39442','64809','26624','25794','37422',
                          '16314','32781','91836','14650','11863',
                          '49869','59465','49638','91142','95691',
                          '66360','40141','45001','90781','99732',
                          '27555','61845','71835','89638','87640',
                          '37084','85678','76304','16747','18770',
                          '72040','86465','33307','61743','53183',
                          '96006','12274','24640','98888','38599',
                          '99482','29148','78149','11304','14968',
                          '32978','72586','32511','70755','15541',
                          '94187','19402','54041','11467','96389',
                          '13653','82045','83643','90438','79452',
                          '97519','25324','10237','11013','25124',
                          '65193','99940','48738','27869','51779',
                          '67853','99085','34658','12328','72454',
                          '86318','61885','66983','44482','16586',
                          '75303','35610','21737','60898','62293',
                          '39848','75932','81476','79281','10684',
                          '87962','53125','93580','66277','85016',
                          '16436','35046','37475','27612','29078',
                          '38891','74370','65646','75931','50088',
                          '70456','31431','49671','76796','89645',
                          '51028','34039','87018','73726','99728',
                          '63265','31024','87609','70320','45780',
                          '39694','51507','27922','97521','29015',
                          '34127','22701','45947','23293','30297',
                          '24931','97741','15965','35945','12770',
                          '40767','19060','58675','85006','87647',
                          '37436','97989','84719','78817','75382',
                          '87895','65475','35389','13274','18621',
                          '31250','81304','26512','56992','28310',
                          '52211','87079','38886','50494','20754',
                          '39362','63130','40310','41782','90266',
                          '40626','35012','74233','76983','48028',
                          '39702','38745','19728','79547','52065',
                          '23541','61009','86378','76950','55894',
                          '28010','55211','70441','21189','49269',
                          '11711','43324','25110','90825','34400',
                          '92377','34411','69733','98592','89651',
                          '87429','47988','36462','26693','67625',
                          '54966','63038','70057','64018','37154',
                          '97324','71444','32392','12236','19684',
                          '99558','93680','89502','92442','66582',
                          '95750','43605','21930','42492','15788',
                          '44302','21214','94279','93798','23984',
                          '23281','76808','76746','73896','82601',
                          '60836','79255','40374','80089','36158',
                          '64687','63090','66249','58027')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;
